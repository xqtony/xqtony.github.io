<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>分库分表是什么，怎么做 | 托尼的技术博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  
  
    <link rel="alternate" href="/atom.xml" title="托尼的技术博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="/localshare/css/share.css">

  
  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">托尼的技术博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/."><i class="fa fa-home"></i> 首页</a>
        
          <a class="main-nav-link" href="/archives"><i class="fa fa-archive"></i> 归档</a>
        
          <a class="main-nav-link" href="/about"><i class="fa fa-user"></i> 关于</a>
        
      </nav>
    </div>
    <div id="search-form">
      <div id="result-mask" class="hide"></div>
      <label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label>
      <div id="result-wrap" class="hide">
        <div id="search-result"></div>
      </div>
      <div class="hide">
        <template id="search-tpl">
          <div class="item">
            <a href="/{path}" title="{title}">
              <div class="title">{title}</div>
              <div class="time">{date}</div>
              <div class="tags">{tags}</div>
            </a>
          </div>
        </template>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-分库分表" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      分库分表是什么，怎么做
    </h1>
  


      </header>
    
    <div class="article-meta">
      
      <span class="article-date">
  <i class="fa fa-date"></i>
  <time class="dt-published" datetime="2024-03-12T16:22:19.538Z" itemprop="datePublished">03/13/2024</time>
</span>
      
  <div class="article-category">
    <i class="fa fa-classify"></i>
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>

      
        <span class="article-views">
  <i class="fa fa-views"></i>
  <i id="busuanzi_container_page_pv">
      <i id="busuanzi_value_page_pv"></i>
  </i>
</span>

      
      
<a href="/2024/03/13/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/#comments" class="article-comment-link">
  
    
    
    
    
    
      <i id="changyan_count_unit" data-xid="/2024/03/13/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/"></i>
    
  
  <i class="fa fa-commt"></i>
  留言
</a>


    </div>
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>本文大纲</p>
<ul>
<li>什么是分库分表？</li>
<li>如何切分库和表？</li>
<li>为什么要分库分表？</li>
<li>切分策略</li>
<li>分库分表产生的问题</li>
<li>分库分表如何落地？</li>
</ul>
<span id="more"></span>

<h1 id="什么是分库分表"><a href="#什么是分库分表" class="headerlink" title="什么是分库分表"></a>什么是分库分表</h1><h2 id="1-1-分库"><a href="#1-1-分库" class="headerlink" title="1.1 分库"></a>1.1 分库</h2><p>分库是指在表数量不变的情况下对库进行切分。</p>
<p>举例：如下图，数据库 A 中存放了 user 和 order 两张表，将两张表切分到两个数据库中，user 表放到 database A，order 表放到 database B。</p>
<p><img src="/../images/shard/shard1.png" alt="分库"></p>
<p>1.2 分表</p>
<p>分表是指在库数量不变的情况下对表进行切分。</p>
<p>举例：如下图，数据库 A 中存放了 user 表，将 user 表切分成 user1 和 user2 两张表并放到 database A 中。</p>
<p><img src="/../images/shard/shard2.png" alt="分表"></p>
<p>1.3 分库分表</p>
<p>分库分表是指库和表都切分，数量都发生变化。</p>
<p>举例：如下图，数据库 A 中存放了 user 表，将 user 表切分成 user1、user2、user3、user4 四张表，user1 和 user2 放到 database A 中，user3 和 user4 放到 database B 中。</p>
<p><img src="/../images/shard/image.png" alt="Alt text"></p>
<h1 id="二、如何切分库和表？"><a href="#二、如何切分库和表？" class="headerlink" title="二、如何切分库和表？"></a>二、如何切分库和表？</h1><p>主流的切分方式有 3 种：水平切分、垂直切分和混合切分。 </p>
<h2 id="2-1-水平切分"><a href="#2-1-水平切分" class="headerlink" title="2.1 水平切分"></a>2.1 水平切分</h2><p>水平切分包含水平分库和水平分表。</p>
<h3 id="2-1-1-水平分表"><a href="#2-1-1-水平分表" class="headerlink" title="2.1.1 水平分表"></a>2.1.1 水平分表</h3><p>水平分表指的表结构不变，将单表数据切分成多表。切分后的结果：</p>
<ul>
<li>每个表的结构一样；</li>
<li>每个表的数据不一样；</li>
<li>所有表的数据并集为全量数据；</li>
</ul>
<p>切分抽象图如下：</p>
<p><img src="/../images/shard/image-1.png" alt="Alt text"></p>
<p>举例：如下图，order 表，按照 oder_id 的数据范围水平切分后变成了 order1 和 order2 表，两个表的结构一样，数据不同。</p>
<p><img src="/../images/shard/image-2.png" alt="Alt text"></p>
<h3 id="2-1-2-水平分库"><a href="#2-1-2-水平分库" class="headerlink" title="2.1.2 水平分库"></a>2.1.2 水平分库</h3><p>水平分库是指，将表水平切分后分到不同的数据库，使得每个库具有相同的表，表中的数据不相同，水平分库一般是伴随水平分表。</p>
<p>举例：如下图，order 表，水平切分后，分到 database A 和 database B 中，这样原来一个库就被拆分成 2 个库。</p>
<p><img src="/../images/shard/image-3.png" alt="Alt text"></p>
<h2 id="2-2-垂直切分"><a href="#2-2-垂直切分" class="headerlink" title="2.2 垂直切分"></a>2.2 垂直切分</h2><p>垂直切分包含垂直分库和垂直分表。</p>
<h3 id="2-2-1-垂直分表"><a href="#2-2-1-垂直分表" class="headerlink" title="2.2.1 垂直分表"></a>2.2.1 垂直分表</h3><p>垂直分表指将存在一张表中的字段切分到多张表。切分后的结果：</p>
<ul>
<li>每个表的结构不一样；</li>
<li>每个表的数据不一样；</li>
<li>所有表的字段并集是原表的字段；</li>
</ul>
<p>切分抽象图如下：</p>
<p><img src="/../images/shard/image-4.png" alt="Alt text"></p>
<p>举例：如下图，order 表，根据字段垂直切分，切分后 order_base 表包含一部分字段的数据 和 order_info 表包含另一部分字段的数据。</p>
<p><img src="/../images/shard/image-5.png" alt="Alt text"></p>
<h3 id="2-2-2-垂直分库"><a href="#2-2-2-垂直分库" class="headerlink" title="2.2.2 垂直分库"></a>2.2.2 垂直分库</h3><p>垂直分库指的是，将单个库中的表分到多个库，每个库包含的表不一样。</p>
<p>举例：如下图，database A 中的 order 表 和 user 表，垂直分库为 database A 包含 order 表，database B 包含 user 表。</p>
<p><img src="/../images/shard/image-6.png" alt="Alt text"></p>
<h2 id="2-3-混合切分"><a href="#2-3-混合切分" class="headerlink" title="2.3 混合切分"></a>2.3 混合切分</h2><p>混合切分其实就是水平切分和垂直切分的组合，切分抽象图如下：</p>
<p><img src="/../images/shard/image-7.png" alt="Alt text"></p>
<p>举例：如下图，order 表，按照 oder_id 数据范围做了水平切分，并且按照表字段做了垂直切分。</p>
<p><img src="/../images/shard/image-8.png" alt="Alt text"></p>
<p>说明：上面的举例只是为了更好的展示如何切分，并不包含真实业务内容。</p>
<h1 id="三、为什么要分库分表？"><a href="#三、为什么要分库分表？" class="headerlink" title="三、为什么要分库分表？"></a>三、为什么要分库分表？</h1><h2 id="3-1-单库出现性能瓶颈"><a href="#3-1-单库出现性能瓶颈" class="headerlink" title="3.1 单库出现性能瓶颈"></a>3.1 单库出现性能瓶颈</h2><p>单库出现性能瓶颈，通常有以下几种情况：</p>
<ul>
<li>数据库服务器磁盘空间不足，但是无法扩容，导致写数据异常；</li>
<li>数据库服务器 CPU 压力过大，无法升配，导致读写性能较慢；</li>
<li>数据库服务器内存不足，无法扩容，导致读写性能瓶颈；</li>
<li>数据库服务器网络带宽不足，无法升配，导致读写性能瓶颈；</li>
<li>数据库服务器连接数过多，无法升配，导致客户端连接等待&#x2F;超时；</li>
</ul>
<p>如下图，单库已经达到了性能瓶颈，因此需要扩容成 2 个数据库：</p>
<p><img src="/../images/shard/image-9.png" alt="Alt text"></p>
<p>3.2 单表出现性能瓶颈</p>
<p>单表出现性能瓶颈，通常是因为单表数据量过大，导致读写性能较慢。</p>
<p>如下图，order 表已经达到了性能瓶颈，因此需要切分成 2 张表：</p>
<p><img src="/../images/shard/image-10.png" alt="Alt text"></p>
<h2 id="3-3-微服务化"><a href="#3-3-微服务化" class="headerlink" title="3.3 微服务化"></a>3.3 微服务化</h2><p>因公司架构发展，技术团队需要对服务器进行微服务化，从而分库分表。如下图展示：</p>
<p><img src="/../images/shard/image-11.png" alt="Alt text">   </p>
<h1 id="四、切分策略"><a href="#四、切分策略" class="headerlink" title="四、切分策略"></a>四、切分策略</h1><p>主流的切分策略有 3 种：Range 范围、hash 切分、映射表。</p>
<h2 id="4-1-Range-范围"><a href="#4-1-Range-范围" class="headerlink" title="4.1 Range 范围"></a>4.1 Range 范围</h2><p>Range 范围是指按某个字段的数据区间来进行切分。</p>
<p>比如：user 表按照 user_id 的数据范围切分成多张表，每 1000 万条数据存放一张表，切分后的表可以放到同一个数据库，也可以放到不同的数据库，示例图如下：</p>
<p><img src="/../images/shard/image-12.png" alt="Alt text"></p>
<ul>
<li>优点</li>
</ul>
<p>方便扩容，每次数据量达到 range 值就新加一张表，可以通过代码实现自动化扩容；</p>
<ul>
<li>缺点</li>
</ul>
<p>存在写偏移，可能有热点问题；</p>
<p>举例</p>
<p>比如用户注册场景：user 表，因为新注册的用户数据都是写新表，通常来说新用户的活跃度高，所以读写流量全部集中在最新的 user 表，因此，新表可能存在热点问题。  </p>
<h1 id="4-2-hash-切分"><a href="#4-2-hash-切分" class="headerlink" title="4.2 hash 切分"></a>4.2 hash 切分</h1><p>通过对分表键 key 进行一定的运算（通常有取余、取模运算，比如：key % m，key &#x2F; m，hash(key)&#x2F;m 等等），通过运算结果来决定路由的库和表。目前大多数互联网公司主要采用该方法。</p>
<ul>
<li>优点</li>
</ul>
<p>数据分片比较均匀，大大降低热点问题；</p>
<ul>
<li>缺点</li>
</ul>
<p>hash 算法选择不合理，后期扩容可能需要迁移数据；</p>
<p>数据被切分到不同的库和表中，可能存在跨节点查询和分页等问题；</p>
<p>举例</p>
<p>比如：user 表信息，根据 user_id 对 10 取余，这样就可以通过 user_id 尾号 hash 到 user_0 到 user_9 10 张表中：</p>
<p><img src="/../images/shard/image-13.png" alt="Alt text">   </p>
<h2 id="4-3-映射表"><a href="#4-3-映射表" class="headerlink" title="4.3 映射表"></a>4.3 映射表</h2><p>映射表其实是 Range 范围 和 hash 切分的混合模式，将分表键和数据库的映射关系记录在一个单独的表（表的形式可以是 数据库表，文件或者配置中心）。</p>
<ul>
<li>优点</li>
</ul>
<p>可以灵活设置路由规则；</p>
<ul>
<li>缺点：</li>
</ul>
<p>方案比较复杂；</p>
<p>映射表可能也会随着业务量的增大，同样需要分库分表，带来更多的问题；</p>
<p>举例</p>
<p>某社区电商下单场景，因为全国仓库的数量有限，所以分库直接使用了仓编编码-数据库映射表（后期新增加仓库，只要在表中增加映射关系），为了保证履约的时效性，用户下单时，商城端会选择最近的仓库，服务器在映射表中根据仓库编码查询并路由到对应的数据库，最后在库中进行 order 表的操作，交互如下图：</p>
<p><img src="/../images/shard/image-14.png" alt="Alt text"></p>
<h1 id="五、分库分表产生的问题"><a href="#五、分库分表产生的问题" class="headerlink" title="五、分库分表产生的问题"></a>五、分库分表产生的问题</h1><p>分库分表能够解决性能瓶颈问题，但是分库分表不是银弹，它同样也会带来一些问题：</p>
<ul>
<li>调试和维护难度</li>
<li>分布式事务</li>
<li>分布式事务</li>
<li>跨库关联&#x2F;分页&#x2F;排序</li>
</ul>
<h2 id="5-1-定位和维护难度"><a href="#5-1-定位和维护难度" class="headerlink" title="5.1 定位和维护难度"></a>5.1 定位和维护难度</h2><p>单库单表，可以很直观在表中查看数据，分库分表后，需要先根据 key 找到库和表，这样在一定意义上增加了开发人员定位问题的难度，再因为库和表的增多，维护难度自然也上去了（公司有 DBA 可以交给他们）。   </p>
<h2 id="5-2-分布式-ID"><a href="#5-2-分布式-ID" class="headerlink" title="5.2 分布式 ID"></a>5.2 分布式 ID</h2><p>单库单表，可以直接使用表自增主键保证全局唯一性，分库分表后，需要自己维护全局唯一的 ID，常用的算法有：UUID、号段模式（数据库生成全局 ID）、雪花算法。</p>
<p>UUID 优点：</p>
<p>性能非常高，本地生成，没有网络消耗；</p>
<p>UUID 缺点：</p>
<p>不易于存储：UUID 太长，16 字节 128 位，通常以 36 长度的字符串表示，很多场景不适用;</p>
<p>信息不安全：基于 MAC 地址生成 UUID 的算法可能会造成 MAC 地址泄露，这个漏洞曾被用于寻找梅丽莎病毒的制作者位置;</p>
<p>ID 作为主键时在特定的环境会存在一些问题，比如做 DB 主键的场景下，UUID 就非常不适用。</p>
<p>号段模式优点：</p>
<p>可以每次获取一个 ID，也可以每次获取一批 ID；</p>
<p>简单，利用现有数据库系统的功能实现；</p>
<p>ID 单调自增，可以实现对 ID 要求特殊的业务；</p>
<p>号段模式缺点：</p>
<p>强依赖发号 DB 的性能，可能有单点问题；</p>
<p>雪花算法优点：</p>
<p>毫秒数在高位，自增序列在低位，整个 ID 都是趋势递增的。</p>
<p>不依赖数据库等第三方系统，以服务的方式部署，稳定性更高，生成 ID 的性能也是非常高的。</p>
<p>可以根据自身业务特性分配 bit 位，非常灵活。</p>
<p>雪花算法缺点：</p>
<p>强依赖机器时钟，如果机器时钟回拨，会导致重复或者服务不可用，不过发生的概率比较小；</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>对于公司内部没有分布式 ID 相关实现的，可以使用或借鉴 美团开源的 Leaf ( <a target="_blank" rel="noopener" href="https://github.com/Meituan-Dianping/Leaf">https://github.com/Meituan-Dianping/Leaf</a> ) ，该框架提供了雪花算法和号段模式两种方案。</p>
<h2 id="5-3-分布式事务"><a href="#5-3-分布式事务" class="headerlink" title="5.3 分布式事务"></a>5.3 分布式事务</h2><p>单库单表可以直接使用本地事务来保障数据的正确性，分库分表之后可能就需要引入分布式事务的问题，解决方案有两种：</p>
<p>业务划分的时候规避分布式事务；</p>
<p>使用专业的的分布式框架，比如阿里开源的 Seata ( <a target="_blank" rel="noopener" href="https://seata.io/zh-cn/">https://seata.io/zh-cn/</a> )；</p>
<h2 id="5-4-跨库关联-x2F-分页-x2F-排序"><a href="#5-4-跨库关联-x2F-分页-x2F-排序" class="headerlink" title="5.4 跨库关联&#x2F;分页&#x2F;排序"></a>5.4 跨库关联&#x2F;分页&#x2F;排序</h2><p>单库单表可以直接使用 MySQL limit 特性实现分页，分库分表后，可能会出现分页问题，解决方案有三种：</p>
<p>选择合适的分表字段，规避绝大部分高频查询场景出现跨库；</p>
<p>使用专业的分布式框架，比如开源框架：ElasticSearch ( <a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch">https://github.com/elastic/elasticsearch</a> )；</p>
<p>业务代码中分别查询，然后组装数据；</p>
<h1 id="六、分库分表工具"><a href="#六、分库分表工具" class="headerlink" title="六、分库分表工具"></a>六、分库分表工具</h1><p>分库分表工具主要有 2 种模式：客户端模式 和 代理模式   </p>
<h2 id="6-1-客户端模式"><a href="#6-1-客户端模式" class="headerlink" title="6.1 客户端模式"></a>6.1 客户端模式</h2><p>客户端模式是指在客户端实现直连数据库，客户端通常是通过一些封装好的 jar 来实现，如下图所示：</p>
<p><img src="/../images/shard/image-15.png" alt="Alt text"></p>
<p>常见的开源中间件有：Apache 的 Sharding-JDBC、淘宝的 TDDL、美图的 Zebra。</p>
<h2 id="6-2-代理模式"><a href="#6-2-代理模式" class="headerlink" title="6.2 代理模式"></a>6.2 代理模式</h2><p>代理模式是指需要单独部署服务，客户端连接代理服务，由代理服务再和数据库交互，如下图所示：</p>
<p><img src="/../images/shard/image-16.png" alt="Alt text"></p>
<p>常见的开源中间件有：Apache 的 Sharding-Proxy、阿里的 cobar、国产的 MyCat、360 的 Atlas。</p>
<p>另外还有 google 的 vitess，它是基于 zookeeper，通过 RPC 方式进行数据管理。   </p>
<h2 id="6-3-总结"><a href="#6-3-总结" class="headerlink" title="6.3 总结"></a>6.3 总结</h2><p>两种方案的核心思想都是类似的，都是将分库分表的逻辑进行抽象封装，业务无需关注分库分表的实现细节，只需按照规则进行简单的配置和开发，就能正常的使用分库分表。</p>
<p>两者各有优劣，客户端模式比较轻量，性能也会比较好；代理模式，客户端无需维护服务，但是需要部署额外的代理服务器，代理服务器的稳定性和性能等都需要保障。</p>
<h1 id="七、分库分表如何落地？"><a href="#七、分库分表如何落地？" class="headerlink" title="七、分库分表如何落地？"></a>七、分库分表如何落地？</h1><p>敲黑板……重点，重点，重点，重要的事情说三遍！！！</p>
<p>互联网业内有句经典名言”Talk is cheap.Show me your code”，理论讲再多，无法付诸实际生产都是空谈。</p>
<p>这里以某大厂社区电商订单业务的真实案例来分享如何落地分库分表。</p>
<h2 id="场景：社区电商下每日-3000-万下单场景"><a href="#场景：社区电商下每日-3000-万下单场景" class="headerlink" title="场景：社区电商下每日 3000 万下单场景"></a>场景：社区电商下每日 3000 万下单场景</h2><h3 id="评估库和表的总数"><a href="#评估库和表的总数" class="headerlink" title="评估库和表的总数"></a>评估库和表的总数</h3><p>一般评估的标准是：当前日订单峰值 M  支持最大的爆发增长速率 R  业务能支撑 Y 年发展 * 365 天&#x2F;年，单表存储 1000 万数据按。</p>
<p>预估数据总数：日订单 3000 万，一年按 365 天计数，最大支持日订单 10 倍的增长速度（即日订单量 1 亿），业务能支撑 10 年发展，因此，需要存储的总订单量 Total &#x3D; 3000w  365  10 * 10 ≈ 10000 亿，万亿级。</p>
<p>评估库和表的总数：每张表按 1000 万存储（库总数  表总数 &#x3D; 10000 亿 &#x2F; 1000 万），因此，库总数  表总数 &#x3D; 10 万，组合方式有『1 个库  10 万张表、10 个库  1 万张表、100 个库  1000 张表 等』，整体来看，”100 个库  1000 张表”这种组合数据离散比较均匀，在计算机中，一般采用 2^n 来计数。所以，100 个库  1000 张表可以比较接近 2^7  2^10 &#x3D; 128 * 1024，所以最终 128 个库，每个库 1024 张表。</p>
<h3 id="分库分表字段的选择"><a href="#分库分表字段的选择" class="headerlink" title="分库分表字段的选择"></a>分库分表字段的选择</h3><p>在单库单表中，可以直接进行 join 查询和分页操作，分库分表后，数据会分到不同的数据库和表上，可能会导致跨库查询等问题，因此，分表字段的选择，决定了能否将原本需要进行分页的数据划分到同一张表上，从而避免跨库查询。</p>
<p>So，如何选择分库分表字段？</p>
<p>有用过社区电商产品（橙心优选，美团优选，多多买菜，盒马邻里）的小伙伴应该知道，社区电商的模式是：当日购买，次日履约。</p>
<p>为了保证履约的时效，用户在下单时，商城端都是把订单下到最近的仓库，因此，可以根据仓库编码来分库。</p>
<p><img src="/../images/shard/image-17.png" alt="Alt text"></p>
<p>在整个销售链路和履约链路中，有几个高发的订单查询场景，因此分表字段的选择必须满足这些场景：</p>
<p>用户视角：查询自己所有的订单，因此，可以通过 user_id 分表，把某用户所有的订单放到同一张表。</p>
<p>团长视角：查询用户下给自己的所有订单，因此，可以通过 tuan_user_id 分表，把某团长的所有的订单放到同一张表。</p>
<p>商家视角：查询用户下给自己的所有订单，因此，可以通过 merchant_id 分表，把某商家的所有的订单放到同一张表。</p>
<p>客服视角：通过订单号查询某个订单，因此，通过 order_id 分表能够快速查询订单信息。</p>
<p>上述 4 种场景都是订单表高发查询的场景，但是目前常用的分库分表中间件都只能支持一个分表字段，该如何解决上面 4 种查询问题呢？</p>
<p>通常的做法有：冗余数据和关系索引表。</p>
<p>其实在计算中的世界很多时候都是时间和空间的一个权衡问题，是拿时间换空间，还是拿空间换时间？冗余数据和关系索引表就很好的体现了时间和空间的权衡关系。</p>
<h3 id="冗余数据："><a href="#冗余数据：" class="headerlink" title="冗余数据："></a>冗余数据：</h3><p>相同的数据保存多份，每份数据使用不同的分表字段，从而满足各种查询需求。如下图所示：通过 user_id、tuan_user_id、merchant_id、order_id 4 个字段来分表，因此需要冗余 4 份相同数据的 order 表。</p>
<p><img src="/../images/shard/image-18.png" alt="Alt text"></p>
<p>很显然，冗余数据是通过空间换时间的做法，优点是只要一次查询请求就能满足业务需求，缺点就是相同数据保存多份，浪费了空间，增加了成本。</p>
<p>淘宝的订单表采用的是数据冗余，拆分买家库和卖家库两个库，一个订单，在买家和卖家库里都存储了一份。</p>
<h3 id="关系索引表："><a href="#关系索引表：" class="headerlink" title="关系索引表："></a>关系索引表：</h3><p>它是指建立查询条件和基表分表键的索引关系。如下图，订单表是基表，通过建立 user_id 和 order_id，tuan_user_id 和 order_id，merchant_id 和 order_id 的关系索引表来满足几种查询场景：</p>
<p><img src="/../images/shard/image-19.png" alt="Alt text"></p>
<p>很显然，关系索引表是通过时间换空间的做法，优点是相对数据冗余法节省了空间和成本，缺点是多了一次索引表的查询，因此时间相对就增加了。该方式额外增加的时间在高并发特别大的场景就能显现出来。</p>
<p>因此，最后分库分表模型是根据仓库编码 warehouse_code 来分库，根据分表字段路由到 order 表，如下图：</p>
<p><img src="/../images/shard/image-20.png" alt="Alt text"></p>
<h3 id="Q-amp-A："><a href="#Q-amp-A：" class="headerlink" title="Q&amp;A："></a>Q&amp;A：</h3><ul>
<li>疑问 1：上述案例的数据库只能支撑 10 年，10 年以后的数据怎么存储？</li>
</ul>
<p>有过网购经验的小伙伴应该都很少去查询 3 年前的数据，因此，我们可以设置一个冷热数据，比如按 3 年划分，3 年内数据可以放到数据库做热数据，3 年前的数据可以归档到 ElasticSearch&#x2F;hive，做冷数据查询。</p>
<ul>
<li>疑问 2：如何查询某一时间段的订单？</li>
</ul>
<p>可以同步到 ElasticSearch&#x2F;hive，这样就可以很方便的按时间段来查询。</p>
<ul>
<li>疑问 3：上述案例是基于新业务，如果已经有线上服务和数据，该如何分库分表？</li>
</ul>
<p>这个场景是很多公司面临的问题，因此这里给出一个切分的常用处理流程：</p>
<p>立项讨论：</p>
<p>这个步骤需要完成和相关部门以及人员确认分库分表事项、实施日程、后期周知、风险以及应对方案等事宜。</p>
<p>技术方案：</p>
<p>技术方案需要给出详细迁移方案，包括分库分表方案，代码改造，服务器过渡到新库新表方案，数据迁移方案，风险处理方案等。</p>
<p>代码改造：</p>
<p>代码改造，主要会涉及到几个部分：服务如何过渡到新库新表，如何灵活支持灰度读写操作，如何进行数据全量迁移、一致性校验等任务。</p>
<p>分库分表方案：</p>
<p>分库分表方案需要确认分库分表的字段，库和表的数量等问题，可以参考上文 社区电商分库分表落地方案。</p>
<p>数据同步：</p>
<p>数据同步有全量数据迁移、增量数据同步以及数据校验、优化和补偿。</p>
<p>数据全量迁移常用方案：开发代码将老库数据迁移到新库；使用中间件同步工具（比如：阿里的 canal）将老库数据同步到新库。</p>
<p>增量数据同步常用方案：同步双写，在写数据库的地方修改成写两份数据；异步双写，写老库，监听 binlog 异步同步到新库；中间件同步：通过中间件（比如：阿里的 canal）将数据同步到目标库表。</p>
<p>数据校验常用方案：增量数据校验 和 全量数据校验 和 人工抽检。</p>
<p>数据校验核心流程：分别读取老库数据和新库数据，然后比较，数据一致则继续比较下一条数据，数据不一致则进行补偿。</p>
<p>数据补偿核心流程：新库存在老库不存在，则新库删除数据；新库不存在老库存在，则新库插入数据；新库存在老库存在，则比较所有字段，不一致则将新库更新为老库数据。</p>
<p>风险处理方案：</p>
<p>风险处理包含部门间配合，技术方案的处理（服务回滚，数据修复等）</p>
<h1 id="八、总结"><a href="#八、总结" class="headerlink" title="八、总结"></a>八、总结</h1><p>首先，本文从分库分表的理论到分库分表的实例落地分享，但是百种业务百种架构，百种架构百种方案，本文可以给分库分表一个很好的参考意义。</p>
<p>其次，数据分库分表技术难度比较大，特别是从现有业务改造，需要考虑数据的迁移以及服务器平稳过渡到新库新表，因此整个迁移过程都是一个很大的考验。</p>
<p>最后，我们分享了一个分库分表的常用流程，因为涉及点太多，所以只能给出一个业内常用的方案，很多细节点还需要在实施前充分去补充和完善。</p>
<h1 id="九、-代码实例"><a href="#九、-代码实例" class="headerlink" title="九、 代码实例"></a>九、 代码实例</h1><p>创建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_bill_2021_1` (</span><br><span class="line">  `order_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>  COMMENT <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">int</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `address_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;地址id&#x27;</span>,</span><br><span class="line">  `status` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单状态&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`order_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_bill_2021_2` (</span><br><span class="line">  `order_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>  COMMENT <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">int</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `address_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;地址id&#x27;</span>,</span><br><span class="line">  `status` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单状态&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`order_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br><span class="line"><span class="comment">-- 省略....</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_bill_2021_12` (</span><br><span class="line">  `order_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>  COMMENT <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">int</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `address_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;地址id&#x27;</span>,</span><br><span class="line">  `status` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单状态&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`order_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br></pre></td></tr></table></figure>

<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">		 <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>wyd<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>wyd<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">mybatis-plus.version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">mybatis-plus.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">sharding-sphere.version</span>&gt;</span>4.0.0-RC2<span class="tag">&lt;/<span class="name">sharding-sphere.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">shardingsphere.version</span>&gt;</span>5.0.0-beta<span class="tag">&lt;/<span class="name">shardingsphere.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>joda-time<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>joda-time<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-namespace<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.postgresql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.wyd.dao;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName(&quot;t_bill&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bill</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long orderId;</span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line">    <span class="keyword">private</span> Long addressId;</span><br><span class="line">    <span class="keyword">private</span> String status;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOrderId</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderId = orderId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserId</span><span class="params">(Integer userId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAddressId</span><span class="params">(Long addressId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.addressId = addressId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStatus</span><span class="params">(String status)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.status = status;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreateTime</span><span class="params">(Date createTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分库算法</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.wyd;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.api.sharding.standard.PreciseShardingAlgorithm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shardingsphere.api.sharding.standard.PreciseShardingValue;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="comment">//自定义数据库分片算法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DBShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title class_">PreciseShardingAlgorithm</span>&lt;Long&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, PreciseShardingValue&lt;Long&gt; shardingValue)</span> &#123;</span><br><span class="line">        <span class="comment">//真实数据库节点</span></span><br><span class="line">        availableTargetNames.stream().forEach((item) -&gt; &#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;actual db:&quot;</span> + item);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//逻辑表以及分片的字段名</span></span><br><span class="line">        System.out.println(<span class="string">&quot;logicTable:&quot;</span>+shardingValue.getLogicTableName()+<span class="string">&quot;;shardingColumn:&quot;</span>+ shardingValue.getColumnName());</span><br><span class="line">        <span class="comment">//分片数据字段值</span></span><br><span class="line">        System.out.println(<span class="string">&quot;shardingColumn value:&quot;</span>+ shardingValue.getValue().toString());</span><br><span class="line">        <span class="comment">//获取字段值</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> shardingValue.getValue();</span><br><span class="line">        <span class="comment">//分片索引计算 0 , 1</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">db_index</span> <span class="operator">=</span> orderId &amp; (<span class="number">2</span> - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (String each : availableTargetNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (each.equals(<span class="string">&quot;ds&quot;</span>+db_index)) &#123;</span><br><span class="line">                <span class="comment">//匹配的话，返回数据库名</span></span><br><span class="line">                <span class="keyword">return</span> each;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIwNDAyOTI2Nw==&mid=2247484608&idx=1&sn=c2deb84f4dabf5838fafe77ab274dfba&chksm=96c728fca1b0a1ea307ac9aefae146d39e6367732537d460d4a1581696bf05a7729201604ea4&token=1026451003&lang=zh_CN#rd">大厂实例分享：每日 3000万订单，如何分库分表</a><br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/448775613/answer/2053752631">什么是分库分表，为什么要分库分表？ - 华为云开发者联盟的回答 - 知乎</a></p>

        
            <div id="toc-article">
                
  <div class="widget-wrap" id="toc-wrap">
    <h3 class="widget-title"><i class="fa fa-toc"></i> 文章目录</h3>
    <div class="widget">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-text">什么是分库分表</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%88%86%E5%BA%93"><span class="toc-text">1.1 分库</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%A6%82%E4%BD%95%E5%88%87%E5%88%86%E5%BA%93%E5%92%8C%E8%A1%A8%EF%BC%9F"><span class="toc-text">二、如何切分库和表？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%B0%B4%E5%B9%B3%E5%88%87%E5%88%86"><span class="toc-text">2.1 水平切分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-%E6%B0%B4%E5%B9%B3%E5%88%86%E8%A1%A8"><span class="toc-text">2.1.1 水平分表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-%E6%B0%B4%E5%B9%B3%E5%88%86%E5%BA%93"><span class="toc-text">2.1.2 水平分库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%9E%82%E7%9B%B4%E5%88%87%E5%88%86"><span class="toc-text">2.2 垂直切分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E5%9E%82%E7%9B%B4%E5%88%86%E8%A1%A8"><span class="toc-text">2.2.1 垂直分表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E5%9E%82%E7%9B%B4%E5%88%86%E5%BA%93"><span class="toc-text">2.2.2 垂直分库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%B7%B7%E5%90%88%E5%88%87%E5%88%86"><span class="toc-text">2.3 混合切分</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%EF%BC%9F"><span class="toc-text">三、为什么要分库分表？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%8D%95%E5%BA%93%E5%87%BA%E7%8E%B0%E6%80%A7%E8%83%BD%E7%93%B6%E9%A2%88"><span class="toc-text">3.1 单库出现性能瓶颈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%96"><span class="toc-text">3.3 微服务化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%88%87%E5%88%86%E7%AD%96%E7%95%A5"><span class="toc-text">四、切分策略</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-Range-%E8%8C%83%E5%9B%B4"><span class="toc-text">4.1 Range 范围</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-2-hash-%E5%88%87%E5%88%86"><span class="toc-text">4.2 hash 切分</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E6%98%A0%E5%B0%84%E8%A1%A8"><span class="toc-text">4.3 映射表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%BA%A7%E7%94%9F%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">五、分库分表产生的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E5%AE%9A%E4%BD%8D%E5%92%8C%E7%BB%B4%E6%8A%A4%E9%9A%BE%E5%BA%A6"><span class="toc-text">5.1 定位和维护难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E5%88%86%E5%B8%83%E5%BC%8F-ID"><span class="toc-text">5.2 分布式 ID</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-text">5.3 分布式事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E8%B7%A8%E5%BA%93%E5%85%B3%E8%81%94-x2F-%E5%88%86%E9%A1%B5-x2F-%E6%8E%92%E5%BA%8F"><span class="toc-text">5.4 跨库关联&#x2F;分页&#x2F;排序</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%B7%A5%E5%85%B7"><span class="toc-text">六、分库分表工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A8%A1%E5%BC%8F"><span class="toc-text">6.1 客户端模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-text">6.2 代理模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E6%80%BB%E7%BB%93"><span class="toc-text">6.3 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%A6%82%E4%BD%95%E8%90%BD%E5%9C%B0%EF%BC%9F"><span class="toc-text">七、分库分表如何落地？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%EF%BC%9A%E7%A4%BE%E5%8C%BA%E7%94%B5%E5%95%86%E4%B8%8B%E6%AF%8F%E6%97%A5-3000-%E4%B8%87%E4%B8%8B%E5%8D%95%E5%9C%BA%E6%99%AF"><span class="toc-text">场景：社区电商下每日 3000 万下单场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%84%E4%BC%B0%E5%BA%93%E5%92%8C%E8%A1%A8%E7%9A%84%E6%80%BB%E6%95%B0"><span class="toc-text">评估库和表的总数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AD%97%E6%AE%B5%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-text">分库分表字段的选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%97%E4%BD%99%E6%95%B0%E6%8D%AE%EF%BC%9A"><span class="toc-text">冗余数据：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E7%B3%BB%E7%B4%A2%E5%BC%95%E8%A1%A8%EF%BC%9A"><span class="toc-text">关系索引表：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Q-amp-A%EF%BC%9A"><span class="toc-text">Q&amp;A：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">八、总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81-%E4%BB%A3%E7%A0%81%E5%AE%9E%E4%BE%8B"><span class="toc-text">九、 代码实例</span></a></li></ol>
    </div>
  </div>


            </div>
        
        
          <blockquote id="copyright">
              <p>原文链接: <a href="https://xqtony.github.io/2024/03/13/分库分表/">https://xqtony.github.io/2024/03/13/分库分表/</a></p>
              <p>版权声明: 转载请注明出处.</p>
          </blockquote>
        
      
    </div>
    <footer class="article-footer">
      
        <div class="article-tag-wrap">
          

          
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li></ul>

          
    <div class="social-share">
      <span>分享到:</span>
    </div>



        </div>
      
      
        
<nav id="article-nav">
  
    <a href="/2023/10/15/JVM%20basics/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">older</strong>
      <div class="article-nav-title">
        
          JVM核心知识
        
      </div>
    </a>
  
  
    <a href="/2024/12/09/binary-tree-inorder/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">newer</strong>
      <div class="article-nav-title">
        
          二叉树的中序遍历
        
      </div>
    </a>
  
</nav>

      
      
        







  <div id="comments"><div id="SOHUCS" sid="2024/03/13/分库分表/"></div></div>


      
    </footer>
  </div>
</article>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-posts"></i> 最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/12/10/104%20%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E6%9C%80%E5%A4%A7%E6%B7%B1%E5%BA%A6/">二叉树的中序遍历</a>
          </li>
        
          <li>
            <a href="/2024/12/09/binary-tree-inorder/">二叉树的中序遍历</a>
          </li>
        
          <li>
            <a href="/2024/03/13/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">分库分表是什么，怎么做</a>
          </li>
        
          <li>
            <a href="/2023/10/15/JVM%20basics/">JVM核心知识</a>
          </li>
        
          <li>
            <a href="/2023/09/26/spring-bean-prototype-issue/">经验贴：Spring Bean的scope你真的会用吗？</a>
          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-tag"></i> 标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/AI%E8%BE%85%E5%8A%A9%E5%88%9B%E4%BD%9C/" style="font-size: 20px;">AI辅助创作</a> <a href="/tags/AWS/" style="font-size: 12.5px;">AWS</a> <a href="/tags/Arrays/" style="font-size: 10px;">Arrays</a> <a href="/tags/BigDecimal/" style="font-size: 10px;">BigDecimal</a> <a href="/tags/Cloud/" style="font-size: 12.5px;">Cloud</a> <a href="/tags/Collections/" style="font-size: 12.5px;">Collections</a> <a href="/tags/Comparable/" style="font-size: 10px;">Comparable</a> <a href="/tags/Comparator/" style="font-size: 15px;">Comparator</a> <a href="/tags/Java/" style="font-size: 17.5px;">Java</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/Lambda/" style="font-size: 10px;">Lambda</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Prototype/" style="font-size: 10px;">Prototype</a> <a href="/tags/Spring/" style="font-size: 10px;">Spring</a> <a href="/tags/Spring-Bean/" style="font-size: 10px;">Spring Bean</a> <a href="/tags/Spring-Boot/" style="font-size: 10px;">Spring Boot</a> <a href="/tags/Zookeeper/" style="font-size: 10px;">Zookeeper</a> <a href="/tags/compare/" style="font-size: 15px;">compare</a> <a href="/tags/compareTo/" style="font-size: 12.5px;">compareTo</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/sort/" style="font-size: 10px;">sort</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/%E4%B8%AD%E5%BA%8F%E9%81%8D%E5%8E%86/" style="font-size: 10px;">中序遍历</a> <a href="/tags/%E4%BA%8C%E5%88%9B/" style="font-size: 15px;">二创</a> <a href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" style="font-size: 12.5px;">二叉树</a> <a href="/tags/%E4%BA%91%E6%8A%80%E6%9C%AF/" style="font-size: 12.5px;">云技术</a> <a href="/tags/%E5%8E%9F%E5%88%9B/" style="font-size: 17.5px;">原创</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 12.5px;">算法</a> <a href="/tags/%E8%BD%AC%E8%BD%BD/" style="font-size: 10px;">转载</a> <a href="/tags/%E9%80%92%E5%BD%92/" style="font-size: 10px;">递归</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-classify"></i> 分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AWS/">AWS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7%E5%92%8C%E7%B1%BB%E5%BA%93/">Java高级特性和类库</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/">实战经验</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-archive"></i> 归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/">2024年</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023年</a><span class="archive-list-count">13</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-tag"></i> 标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI%E8%BE%85%E5%8A%A9%E5%88%9B%E4%BD%9C/" rel="tag">AI辅助创作</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AWS/" rel="tag">AWS</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Arrays/" rel="tag">Arrays</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BigDecimal/" rel="tag">BigDecimal</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloud/" rel="tag">Cloud</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Collections/" rel="tag">Collections</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Comparable/" rel="tag">Comparable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Comparator/" rel="tag">Comparator</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lambda/" rel="tag">Lambda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Prototype/" rel="tag">Prototype</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Bean/" rel="tag">Spring Bean</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/" rel="tag">Zookeeper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/compare/" rel="tag">compare</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/compareTo/" rel="tag">compareTo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/" rel="tag">reverse</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sort/" rel="tag">sort</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssh/" rel="tag">ssh</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E5%BA%8F%E9%81%8D%E5%8E%86/" rel="tag">中序遍历</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%88%9B/" rel="tag">二创</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" rel="tag">二叉树</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%91%E6%8A%80%E6%9C%AF/" rel="tag">云技术</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%92%E5%BD%92/" rel="tag">递归</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-link"></i> 友情链接</h3>
    <div class="widget">
      <ul>
      
        <li>
          <a target="_blank" rel="noopener" href="https://www.r2coding.com/">Road 2 Coding</a>
        </li>
      
        <li>
          <a target="_blank" rel="noopener" href="http://www.ityouknow.com/">分享技术，品味人生</a>
        </li>
      
      </ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <a id="totop" href="#top"></a>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <p>
        <a href="/sitemap.xml">网站地图</a>
        <span> | </span><a href="/atom.xml">订阅本站</a>
        <span> | </span><a href="/about/">联系博主</a>
      </p>
      
        <p>
          <i class="fa fa-visitors"></i>
          <i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>
          ，
          <i class="fa fa-views"></i>
          <i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>
        </p>
      
      <p>
        <span>Copyright &copy; 2024 Tony Kong.</span>
        <span>Theme by <a href="https://github.com/chaooo/hexo-theme-BlueLake/" target="_blank">BlueLake.</a></span>
        <span>Powered by <a href="https://hexo.io/" target="_blank">Hexo.</a></span>
      </p>
    </div>
  </div>
</footer>

    </div>
  </div>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/search.json.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>






  
<script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  
    
<script src="/localshare/js/social-share.js"></script>

    
<script src="/localshare/js/qrcode.js"></script>

  
  



  

  

  

  

  

  

  

  
    <script>
      window._config = { showScore: true };
      (function(){
        var appid = 'cywH6FxXr';
        var conf = '0e148934918dc59f570bbb420fa4f089';
        var width = window.innerWidth || document.documentElement.clientWidth;
        var nodes =document.getElementsByTagName("head")[0]||document.head||document.documentElement;
        if (/(Android|iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent) && width < 750) {
            window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>');
        }
        else {
          var loadJs=function(d,a){
            var b=document.createElement("script");b.setAttribute("type","text/javascript");
            b.setAttribute("charset","UTF-8");
            b.setAttribute("src",d);
            if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}
            nodes.appendChild(b)
          };
          loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})});
        }
        var loadCss = function(cssString){
          var style=document.createElement("style");
          style.setAttribute("type", "text/css");
          if(style.styleSheet){// IE
              style.styleSheet.cssText = cssString;
          } else {// w3c
              var cssText = document.createTextNode(cssString);
              style.appendChild(cssText);
          }
          nodes.appendChild(style);
        }
      })();
      function removeElement(_element){
          var _parentElement = _element.parentNode;
          if(_parentElement){
                  _parentElement.removeChild(_element);
          }
      }
      var removeAD = document.createElement("div");
      removeAD.id = 'removeAD';
      var adInterval1 = setInterval(function() {
        if(document.querySelector("#feedAv")){
          document.querySelector("[node-type=cmt-list]").appendChild(removeAD);
          document.querySelector("#removeAD").appendChild(document.querySelector("#feedAv"));
          //- removeElement(document.querySelectorAll("#feedAv")[0]);
          var feedAv = document.querySelector("#feedAv").children;
          for( item of feedAv){
            item.style.display = 'none'
          }
          document.querySelector("#removeAD").style.display="none"
          clearInterval(adInterval1);
        }
      },1000);
      var adInterval2 = setInterval(function() {
        if(document.querySelector("#pop_ad")){
          removeElement(document.querySelector("#pop_ad"));
          clearInterval(adInterval2);
        }
      }, 1000);
    </script>
    
<script src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script>

  
  





</body>
</html>